<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WeWork Tour Booking</title>
  <style>
    body { font-family: Inter, Arial, sans-serif; margin:0; padding:12px; background:#f7fafc; color:#111; }
    .card { background:white; border-radius:10px; padding:16px; box-shadow:0 6px 18px rgba(16,24,40,0.06); max-width:420px; margin:0 auto; }
    h3{ margin:0 0 10px 0; color:#007bff; }
    .building-info { background:#fff3e0; padding:8px 12px; border-radius:6px; margin-bottom:12px; font-size:14px; }
    .date-select, .time-grid { margin-top:12px }
    select { width:100%; padding:10px; border-radius:8px; border:1px solid #e6e6e6 }
    .time-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin-top:8px }
    .slot { padding:8px 10px; border-radius:8px; border:1px solid #007bff; text-align:center; cursor:pointer; user-select:none; font-size:12px }
    .slot.selected { background:#007bff; color:white; border-color:#007bff }
    .btn { width:100%; margin-top:12px; padding:10px; border-radius:8px; font-weight:600; border:0; cursor:pointer }
    .btn.book { background:#16a34a; color:white }
    .btn.book:disabled { background:#9ca3af; cursor:not-allowed }
    .loading, .error { padding:10px; color:#374151 }
    .selected-info { background:#f0f8ff; padding:10px; border-radius:6px; margin:10px 0; font-size:14px }
    .error { background:#fee; color:#c53030; border-radius:6px; }
  </style>
</head>
<body>
  <div class="card">
    <h3>üìÖ Book a WeWork Tour</h3>

    <div id="buildingInfo" class="building-info" style="display:none">
      üè¢ <span id="buildingName">Loading location...</span>
    </div>

    <div id="loading" class="loading">Loading available slots‚Ä¶</div>

    <div id="form" style="display:none">
      <div class="date-select">
        <label for="dateSelect">Select date</label>
        <select id="dateSelect"><option value="">‚Äî pick a date ‚Äî</option></select>
      </div>

      <div id="timesWrap" style="display:none">
        <label>Available times</label>
        <div id="timeGrid" class="time-grid"></div>
      </div>

      <div id="selectedInfo" class="selected-info" style="display:none"></div>

      <button id="bookBtn" class="btn book" disabled>Confirm Booking</button>
    </div>

    <div id="error" class="error" style="display:none"></div>
  </div>

<script>
(async function(){
  const params = new URLSearchParams(location.search);
  const buildingId = params.get('building_id') || 'fdb15bdf-19e2-4abe-bd40-7b7fa9816fb5';
  const apiUrl = params.get('api') || 'https://api-lms.wework.co.in/api/tours/';
  const locationName = params.get('location') || 'WeWork Location';

  const el = id => document.getElementById(id);
  const loadingEl = el('loading');
  const formEl = el('form');
  const dateSelect = el('dateSelect');
  const timesWrap = el('timesWrap');
  const timeGrid = el('timeGrid');
  const bookBtn = el('bookBtn');
  const errorEl = el('error');
  const selectedInfoEl = el('selectedInfo');
  const buildingInfoEl = el('buildingInfo');
  const buildingNameEl = el('buildingName');

  let selectedSlot = null;
  let allSlots = [];

  if (locationName && locationName !== 'WeWork Location') {
    buildingNameEl.textContent = locationName;
    buildingInfoEl.style.display = 'block';
  }

  function showError(){
    loadingEl.style.display='none';
    formEl.style.display='none';
    errorEl.style.display = 'block';
    errorEl.innerHTML = `
      <strong>üòî Sorry!</strong><br>
      We're having trouble loading available tour slots right now.<br><br>
      Please try again in a few moments.
    `;
  }

  async function fetchSlots(){
    const url = `${apiUrl}?building_id=${encodeURIComponent(buildingId)}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error("API error");
    const data = await res.json();
    if (!data.success || !data.available_tour_times) throw new Error("No slots");
    allSlots = data.available_tour_times;
    return groupSlotsByDate(allSlots);
  }

  function groupSlotsByDate(slots){
    const grouped = {};
    slots.forEach(slot => {
      if (!grouped[slot.date]) grouped[slot.date] = [];
      grouped[slot.date].push(slot);
    });
    return grouped;
  }

  function populateDates(slotsMap){
    dateSelect.innerHTML = '<option value="">‚Äî pick a date ‚Äî</option>';
    Object.keys(slotsMap).sort().forEach(dateStr => {
      const d = new Date(dateStr + 'T00:00:00');
      const opt = document.createElement('option');
      opt.value = dateStr;
      opt.textContent = d.toLocaleDateString('en-US', {
        weekday:'long', day:'2-digit', month:'short', year:'numeric'
      });
      dateSelect.appendChild(opt);
    });
  }

  function renderTimesForDate(slotsMap, selectedDate){
    timeGrid.innerHTML = '';
    (slotsMap[selectedDate] || []).forEach(slot => {
      const div = document.createElement('div');
      div.className = 'slot';
      div.textContent = slot.start_time;
      div.onclick = () => selectSlot(slot, div);
      timeGrid.appendChild(div);
    });
  }

  function selectSlot(slot, el){
    document.querySelectorAll('.slot').forEach(s => s.classList.remove('selected'));
    el.classList.add('selected');
    selectedSlot = slot;
    selectedInfoEl.innerHTML = `
      <strong>‚úÖ Selected Tour:</strong><br>
      üìÖ ${slot.date}<br>
      üïê ${slot.start_time} - ${slot.end_time}<br>
      üè¢ WeWork
    `;
    selectedInfoEl.style.display = 'block';
    bookBtn.disabled = false;
  }

  try{
    const slotsMap = await fetchSlots();
    loadingEl.style.display = 'none';
    formEl.style.display = 'block';
    populateDates(slotsMap);

    dateSelect.onchange = () => {
      selectedSlot = null;
      selectedInfoEl.style.display = 'none';
      bookBtn.disabled = true;
      if (!dateSelect.value) return (timesWrap.style.display='none');
      renderTimesForDate(slotsMap, dateSelect.value);
      timesWrap.style.display = 'block';
    };

    bookBtn.onclick = () => {
      if (!selectedSlot || !window.parent) return;

      window.parent.postMessage({
        type: 'booking_confirmed',
        payload: {
          building_id: selectedSlot.building_id,
          service_resource_id: selectedSlot.service_resource_id,
          tour_date: selectedSlot.date,
          start_time: selectedSlot.start_time,
          end_time: selectedSlot.end_time
        }
      }, '*');
    };

  } catch {
    showError();
  }
})();
</script>
</body>
</html>
